# Budget Optimizer: Умное распределение рекламного бюджета

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![Pandas](https://img.shields.io/badge/pandas-1.4+-green.svg)](https://pandas.pydata.org/)
[![NumPy](https://img.shields.io/badge/numpy-1.21+-orange.svg)](https://numpy.org/)
[![Status](https://img.shields.io/badge/status-production-brightgreen.svg)]()
[![License](https://img.shields.io/badge/license-MIT-lightgrey.svg)]()

> **Гибридный оптимизатор рекламного портфеля** с приоритезацией кампаний, учётом убывающей отдачи, ограничений DRR и многодневной стабильности.

---

## Оглавление

- [Постановка задачи](#-постановка-задачи)
- [Архитектура решения](#-архитектура-решения)
- [Установка и запуск](#-установка-и-запуск)
- [Математическая модель](#-математическая-модель)
- [Анализ сложности](#-анализ-сложности)
- [Обработка edge-кейсов](#-обработка-edge-кейсов)
- [Результаты](#-результаты)

---

## Постановка задачи

**Дано:**
- Рекламные кампании с функцией выручки  
  `Revenueᵢ(x) = αᵢ·ln(1 + βᵢ·x)`
- Типы кампаний: **снайпер** (быстрый старт), **тягач** (стабильный рост), **балласт** (убыточные)
- Глобальные ограничения: **Total Budget**, **Target DRR**, **min/max spend**
- Дискретность бюджета (step = 500)
- Требование **стабильности на 3–5 дней**

**Цель:**  
Максимизировать дисконтированную прибыль с учётом ограничений и tail-рисков.

```python
max Σᵢ Σₜ γ^(T-t)·(marginᵢ·αᵢ·ln(1+βᵢ·xᵢ(t)) - xᵢ(t))
```

---

## Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                     ВХОДНЫЕ ДАННЫЕ                          │
│  • CSV с историей затрат/выручки                            │
│  • Глобальные ограничения (B, DRR, step)                    │
└─────────────────┬───────────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────────┐
│              ЭТАП 1: ПРЕПРОЦЕССИНГ                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Curve fit   │→ │  CVaR / IQR │→ │  Stability  │          │
│  │ (α, β)      │  │ риск-метрики│  │  score      │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────┬───────────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────────┐
│              ЭТАП 2: КЛАССИФИКАЦИЯ                          │
│  ┌─────────────┐                                            │
│  │ Снайпер     │  β > median & α ≥ Q25                      │
│  │ Тягач       │  β ≤ median & α ≥ Q25                      │
│  │ Балласт     │  α < Q25 & CVaR < Q25                      │
│  └─────────────┘                                            │
└─────────────────┬───────────────────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────────────────┐
│         ЭТАП 3: МНОГОДНЕВНАЯ ОПТИМИЗАЦИЯ                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  День 1: инициализация топ-20 по ROI                │    │
│  │  День t: • оценка ROI с учётом динамики             │    │
│  │          • отключение 10% худших (ROI < 5%)         │    │
│  │          • включение новых кандидатов (ROI > 10%)   │    │
│  │          • округление до step, проверка DRR         │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## Установка и запуск

### Требования
- Python 3.8+
- Pandas, NumPy, SciPy, Matplotlib

### Быстрый старт

```bash
# 1. Клонировать репозиторий
git clone https://github.com/username/budget-optimizer.git
cd budget-optimizer

# 2. Установить зависимости
pip install -r requirements.txt

# 3. Запустить оптимизатор
python optimizer.py
```

### Параметры запуска

| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `--input` | Путь к CSV | test.csv |
| `--budget` | Общий бюджет | 100000 |
| `--drr` | Целевой DRR | 0.15 |
| `--step` | Шаг дискретизации | 500 |
| `--days` | Горизонт планирования | 5 |
| `--gamma` | Фактор дисконтирования | 0.9 |
---

## Математическая модель

### 1. Функция отклика
```math
Revenue_i(x) = \alpha_i \cdot \ln(1 + \beta_i \cdot x)
```
Параметры αᵢ, βᵢ оцениваются через **curve_fit** (SciPy) на исторических данных.

### 2. Прибыль кампании
```math
Profit_i(x) = margin_i \cdot Revenue_i(x) - x
```

### 3. Многодневный score
```math
Score = \sum_{t=1}^{T} \gamma^{(T-t)} \cdot Profit_i(x_i(t)), \quad \gamma = 0.9
```

### 4. Ограничения
```math
\begin{cases}
\sum x_i \leq B \\[4pt]
\dfrac{\sum x_i}{\sum Revenue_i(x_i)} \leq DRR_{target} \\[4pt]
x_i \in \{0\} \cup [min\_spend_i,\ max\_spend_i] \\[4pt]
x_i \equiv 0 \pmod{step} \\[4pt]
|x_i(t) - x_i(t-1)| \leq max\_daily\_change
\end{cases}
```
---

## Анализ сложности

| Операция | Сложность | Комментарий |
|---------|-----------|------------|
| Fitting α,β | O(M·N) | M — итераций оптимизации |
| Классификация | O(N) | One-pass |
| Сортировка активных | O(K log K) | K ≤ N |
| Сортировка кандидатов | O(M log M) | M ≤ N |
| **Итого на день** | **O(N log N)** | ~0.001 сек для N=100 |

**Память:** O(N) — хранение параметров и бюджетов.

---

## Обработка edge-кейсов

### 1. «0 или Min_Spend»
```python
if x > 0:
    x = max(row.min_spend, x)  # поднимаем до минимума
else:
    x = 0  # кампания выключена
```
**Бизнес-логика:** Нельзя дать "немного" денег — либо работаем с минимальным бюджетом, либо отключаем.

### 2. Tail-risk и аномалии
- **IQR-детекция:** `Q1 - 3·IQR` → выброс → снижение маржи на 50%
- **CVaR-фильтр:** 10% наихудших случаев → идентификация балласта
- **Stability score:** `1 - min(CV, 2.0)`, где CV = σ/μ

### 3. Многодневная динамика
- **Снайперы:** `multiplier = 1.0 - 0.03·(day-1)` (выгорание)
- **Тягачи:** `multiplier = 1.0 ± 0.05` (стабильный шум)
- **Балласт:** `multiplier = 1.0 - 0.07·(day-1)` (деградация)

---

## Результаты

### Метрики за 5 дней

| День | Spend | Revenue | Profit | DRR | Active | Stability |
|------|-------|---------|--------|-----|--------|-----------|
| 1 | 50000 | 946739.373 | 896739.373 | 0.053 | 20 | 0.120 |
| 2 | 57500 | 985761.569 | 928261.569 | 0.058 | 25 | 0.132 |
| 3 | 66000 | 1058121.721 | 992121.721 | 0.062 | 30 | 0.164 |
| 4 | 75500 | 1188376.435 | 1112876.435 | 0.064 | 35 | 0.166 |
| 5 | 86000 | 1275845.375 | 1189845.375 | 0.067 | 40 | 0.167 |

### Распределение по типам

| Тип | Кол-во | Маржа | Стабильность | CVaR |
|-----|--------|-------|--------------|------|
| Снайпер | 142 | 1.06 | 0.133 | -1372.131 |
| Тягач | 137 | 0.92 | 0.519 | -438.924 |
| Балласт | 6 | 0.23 | 1.00 | -468.713 |
---